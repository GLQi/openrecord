# LDAP

OPENRECORD allows you to connect to an LDAP store as well. Under the hood it uses [ldapjs](https://www.npmjs.com/package/ldapjs).  
There are also some predefined models if you want to connect to an [Microsoft ActiveDirectory](#activedirectory).
  
## Basic LDAP

The setup is [simmilar to that of an SQL store](setup.md):
```js
const Store = require('openrecord/store/ldap')

const store = new Store({
  url: 'ldap://0.0.0.0:1389', // ldap or ldaps
  base: 'dc=test', // the root to start all queries
  user: 'cn=root', // the path of the user you want to connect as
  password: 'secret' // the users password
})
```

## Model definition

The model definition is also almost the same as for [SQL stores](./definition.md), except for some ldap specific helper functions like `rdnPrefix()` or the more advanced `isContainer()` method.
LDAP models also get some attributes defined by default:
* `dn`: The path
* `parent_dn`: The parent path
* `objectClass`: The LDAP object class

Here are some examples to get started:
```js
store.Model('User', function() {
  this.attribute('username', String) // defines a simple attribute
  this.attribute('memberOf', 'dn_array') // defines an attribute which stores an array of ldap paths

  this.hasParent('ou') // defines a `belongsTo` relation based on ldap paths
  this.hasMany('groups', { from: 'dn', to: 'member' }) // defines a normal `hasMany` relation with the automatically attached attribute `dn`
})

store.Model('Group', function() {
  this.attribute('name', String)
  this.attribute('member', 'dn_array')

  this.hasParent('ou')
  this.belongsToMany('members', { from: 'member' }) // a relation from the `member` attribute (array of paths) to some objects in your ldap store
})

store.Model('Ou', function() {
  this.isContainer('ou') // defines the RDN prefix as well as a `children`, `all_children` and `parent` relation.
  this.attribute('name', String)
})
```

## Query

The `find(dn)` methods takes an LDAP path to get a specifiy object in your tree.  
To start searching only from a specifiy path use `searchRoot(dn)`, which will also take an LDAP path.  
To define the scope of search (`base`, `one`, `sub`) use the `searchScope(scope)` function. `find(dn)` will by default use the `base` scope! The `recusive(boolean)` function will set `one` for `false` and `sub` for `true`.  
And for filters you use the same `where(condition)` method as [described here](query.md#with-conditions).

e.g.
```js
const result = await Ou.searchRoot('ou=test, dc=testdomain, dc=local').include('all_children')
// result will contain the `ou=test, dc=testdomain, dc=local` ou and all child objects.
```

## Modify

To create, update or destroy objects in your ldap store see the [basic docs for modify](modify.md).
Except you'll need to define the `dn` or `cn` attribute as well.

e.g.
```js
const ou = Ou.new({ name: 'Sub', dn: 'ou=sub, ou=create, dc=test' })

ou.children.add(
  User.new({
    cn: 'hugo', // will get the path `cn=hugo, ou=sub, ou=create, dc=test`
    username: 'hugo'
  })
)

await ou.save()
```


# ActiveDirectory

To connect to an ActiveDirectory is rather simple:

```js
const Store = require('openrecord/store/activedirectory')

const store = new Store({
  url: 'ldaps://your.domain', // ldap or ldaps
  base: 'dc=your,dc=domain', // the root to start all queries
  user: 'DOMAIN\\Administrator', // the user you want to connect as
  password: 'secret' // the users password
})

await store.ready() // wait for the connection
const Ou = store.Model('OrganizationalUnit') // the the autogenerated OU model
const result = await Ou.recursive(false) // list all base ous
```

The following models and attributes are already defined:
* **Computer** (objectClass: `top, person, organizationalPerson, user, computer`)
  * `name`
  * `sAMAccountName`
  * `description`
  * `operatingSystem`: readonly
  * `operatingSystemServicePack`: readonly
  * `operatingSystemVersion`: readonly
  * `servicePrincipalName`: readonly
  * `dNSHostName`: readonly
  * `objectGUID`: readonly
  * `objectSid`: readonly
  * `uSNChanged`: readonly
  * `whenChanged`: readonly
  * `whenCreated`: readonly
  * `accountExpires`
  * `pwdLastSet`
  * `badPasswordTime`: readonly
  * `lastLogon`: readonly
  * `lastLogoff`: readonly
  * `badPwdCount`: readonly
  * `logonCount`: readonly
  * `userAccountControl`: see [user account controls](#user-account-controls) for details
  * `memberOf`
  * hasParent(`ou`)
  * belongsToMany(`members`)
* **Container** (objectClass: `top, container`)
  * `name`
  * `cn`
  * `description`
  * `objectGUID`: readonly
  * `uSNChanged`: readonly
  * `whenChanged`: readonly
  * `whenCreated`: readonly
* **Group** (objectClass: `top, group`)
  * `name`
  * `sAMAccountName`
  * `groupType`: see [group type]()
  * `description`
  * `objectGUID`: readonly
  * `objectSid`: readonly
  * `uSNChanged`: readonly
  * `whenChanged`: readonly
  * `whenCreated`: readonly
  * `member`
  * hasParent(`ou`)
  * belongsToMany(`members`)
* **OrganizationalUnit** (objectClass: `top, organizationalUnit`)
  * `name`
  * `description`
  * `objectGUID`: readonly
  * `uSNChanged`: readonly
  * `whenChanged`: readonly
  * `whenCreated`: readonly
  * hasChildren(`ous`)
  * hasChildren(`users`)
  * hasChildren(`groups`)
  * hasChildren(`computers`)
* **User** (objectClass: `top, person, organizationalPerson, user`)
  * `name`
  * `givenName`
  * `cn`
  * `sn`
  * `displayName`
  * `sAMAccountName`
  * `userPrincipalName`
  * `email`
  * `description`
  * `unicodePwd`: writeonly
  * `objectGUID`: readonly
  * `objectSid`: readonly
  * `uSNChanged`: readonly
  * `whenChanged`: readonly
  * `whenCreated`: readonly
  * `accountExpires`
  * `pwdLastSet`
  * `badPasswordTime`: readonly
  * `lastLogon`: readonly
  * `lastLogoff`: readonly
  * `badPwdCount`: readonly
  * `logonCount`: readonly
  * `homeDirectory`
  * `homeDrive`
  * `userAccountControl`: see [user account controls](#user-account-controls) for details
  * `memberOf`
  * hasParent(`ou`)
  * hasMany(`groups`)
  * Record methods:
    * `checkPassword(password) => Promise`
 

!> If you want to change the password of a user (`unicodePwd`) via OPENRECORD you'll need to connect via ldaps to your ActiveDirectory!


## User Account Controls
The `userAccountControl` attributes contains an object with the follogin keys.
Every key accepts a boolean value and will be translated internally to the appropiate [bitmask](https://support.microsoft.com/en-us/help/305144/how-to-use-useraccountcontrol-to-manipulate-user-account-properties):
* SCRIPT
* ACCOUNTDISABLED
* HOMEDIR_REQUIRED
* LOCKOUT
* PASSWD_NOTREQUIRED
* PASSWD_CANT_CHANGE
* ENCRYPTED_TEXT_PWD_ALLOWED
* TEMP_DUPLICATE_ACCOUNT
* NORMAL_ACCOUNT
* INTERDOMAIN_TRUST_ACCOUNT
* WORKSTATION_TRUST_ACCOUNT
* SERVER_TRUST_ACCOUNT
* DONT_EXPIRE_PASSWORD
* MNS_LOGON_ACCOUNT
* SMARTCARD_REQUIRED
* TRUSTED_FOR_DELEGATION
* NOT_DELEGATED
* USE_DES_KEY_ONLY
* DONT_REQ_PREAUTH
* PASSWORD_EXPIRED
* TRUSTED_TO_AUTH_FOR_DELEGATION
* PARTIAL_SECRETS_ACCOUNT

## Group Type
The `grouptype` attributes contains an object with the follogin keys.
Every key accepts a boolean value and will be translated internally to the appropiate [bitmask](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/11972272-09ec-4a42-bf5e-3e99b321cf55):
* BUILTIN_LOCAL_GROUP
* ACCOUNT_GROUP
* RESOURCE_GROUP
* UNIVERSAL_GROUP
* APP_BASIC_GROUP
* APP_QUERY_GROUP
* SECURITY_ENABLED